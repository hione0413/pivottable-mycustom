<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/plugin/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/plugin/datepicker/datepicker3.min.css" />
    <link rel="stylesheet" href="/plugin/iCheck/square/blue.css" />
    <link rel="stylesheet" href="/custom_resource/css/z-top.css" />
    <link rel="stylesheet" href="/custom_resource/lib/zPivottable/pivot.css" /> <!-- customize lib : zPivottable -->
    <link rel="stylesheet" href="/custom_resource/lib/zCardUIDesign/zCardUIDesign.css">

    <!-- fullcalendar -->
    <link rel="stylesheet" href="/custom_resource/lib/fullcalendar/core/main.min.css" />

    <script src="/plugin/jQuery/jQuery-2.1.4.min.js"></script>
    <script src="/plugin/jQueryUI/jquery-ui.min.js"></script>
    <script src="/plugin/bootstrap/js/bootstrap.min.js"></script>
    <script src="/plugin/datepicker/bootstrap-datepicker.min.js"></script>
    <script src="/plugin/datepicker/locales/bootstrap-datepicker.kr.js" charset="UTF-8"></script>
    <script src="/plugin/iCheck/icheck.min.js"></script>
    <script src="/custom_resource/lib/zPivottable/pivot.min.js"></script> <!-- customize lib : zPivottable -->

    <!-- fullcalendar -->
    <script src="/custom_resource/lib/fullcalendar/core/main.min.js"></script>
    <script src="/custom_resource/lib/fullcalendar/core/locales/ko.js"></script>

</head>

<body class="main">
    <div class="container-fluid">
        <!-- 필터 영역 Start -->
        <div class="z-top">
            <div>
                <div class="z-title-wrapper">
                    <label class="z-title">국립중앙박물관 통계 시스템 </label>
                </div>
            </div>
            <div class="z-filter-wrapper">
                <form class="form-inline">
                    <div class="form-group z-filter-group">
                        <input type="radio" name="check" id="check1" checked />
                        <label for="check1" class="z-filter-check-label">연별</label>
                        <input type="radio" name="check" id="check2" />
                        <label for="check2" class="z-filter-check-label">월별</label>
                        <input type="radio" name="check" id="check3" />
                        <label for="check3" class="z-filter-check-label">일별</label>
                    </div>
                    <div class="form-group z-filter-group">
                        <label>SELECT</label>
                        <span class="z-filter-separator">|</span>
                        <select class="form-control">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                        </select>
                    </div>
                    <div class="form-group z-filter-group">
                        <label>기간조회</label>
                        <span class="z-filter-separator">|</span>
                        <input type="text" class="form-control z-filter-textbox" id="startDt" placeholder="2021-08-13">
                        <span class="z-filter-separator">~</span>
                        <input type="text" class="form-control z-filter-textbox" id="endDt" placeholder="2021-09-13">
                    </div>
                    <button type="button" class="btn btn-default z-filter-btn">조회</button>
                </form>
            </div>
        </div>
        <!-- 필터 영역 End -->

        <!-- Calendar 영역 Start -->
        <div class="minwon row">
            <div class="col-md-12">
                <div class="z-card-wrapper">
                    <div class="z-card">
                        <div class="z-card-preview">
                            <span class="z-card-title">히트맵테이블</span>
                        </div>
                        <div class="z-card-info">
                            <div id="targetDiv"></div>
                        </div>
                        <div class="z-card-footer">
                            <button type="button" class="btn btn-default" id="btnExcelDownload">엑셀 다운로드</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Calendar 영역 End -->


    </div>
</body>
<script>

    // Datapicker setting start
    var datapickerFormat = "yyyy-mm-dd";
    $("#startDt").datepicker({
        format: datapickerFormat,
        language: 'kr'
    });
    $("#endDt").datepicker({
        format: datapickerFormat,
        language: 'kr'
    });
    // Datapicker setting End

    // iCheck setting Start 
    $("input[name=check]").iCheck({
        radioClass: 'iradio_square-blue',

    });
    // iCheck setting End


    function createHeatMapTable(targetDivId, dimensionName, pData) {

        for (var i = 0; i < pData.length; i++) {

        }

    }


    function realignDataForHeatMapTable(pData, dimFirst, dimSecond, measure) {
        var result = [];
        var tempObj = {};
        var tempTotal = 0;
        var tempMin = 0;
        var tempMax = 0;

        for (var i = 0; i < pData.length; i++) {
            var rowData = pData[i];

            var dimFVal = rowData[dimFirst];
            var dimSVal = rowData[dimSecond];
            var meaVal = rowData[measure];

            // 0. min max total 세팅
            tempMax = tempMax === 0 ? meaVal : Math.max(tempMax, meaVal);
            tempMin = tempMin === 0 ? meaVal : Math.min(tempMin, meaVal);
            tempTotal += meaVal;

            // end. dimension First 값이 기존과 다를 경우 obj -> arr에 저장 후 초기화
            if (tempObj[dimFirst] && tempObj[dimFirst] !== rowData[dimFirst]) {
                tempObj.max = tempMax;
                tempObj.min = tempMin;
                tempObj.totle = tempTotal;
                tempMax = 0;
                tempMin = 0;
                tempTotal = 0;
                result.push(tempObj);
                tempObj = {};
            }

            // 1. dimension First 값 세팅
            if (!tempObj[dimFirst]) {
                tempObj[dimFirst] = dimFVal;
            }

            // 2. 
            if (!tempObj["value"]) {
                tempObj["value"] = [];
            }

            tempObj["value"].push([dimSVal, meaVal]);

            // end. 마지막 obj -> arr 저장
            if (i === pData.length - 1) {
                tempObj.max = tempMax;
                tempObj.min = tempMin;
                tempObj.totle = tempTotal;
                result.push(tempObj);
            }
        }

        // [
        //     {
        //         "연령대": "10대",
        //         "min": 5,
        //         "max": 100,
        //         "total": 200,
        //         "value": [
        //             ["본관출입", 10],
        //             ["검색PC이동", 20]
        //         ]
        //     },
        // ]

        console.log("result", result);
        return result;
    }

    // HeatMap Table Start
    $.getJSON("/data/heat_map_data.json", function (data) {
        // TODO : 데이터 가져오는 부분은 Ajax(동기화)로 수정 예정
        var dataSet = data.data;

        // console.log("dataSet", dataSet);

        dataSet = realignDataForHeatMapTable(dataSet, "연령대", "이용구분", "이용시간");

        createHeatMapTable("targetDiv", "연령대", dataSet);

    });
    // HeatMap Table End

</script>

</html>